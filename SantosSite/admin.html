<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Completo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; }
        .card-dashboard { border: none; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .btn-circle { width: 32px; height: 32px; border-radius: 50%; padding: 0; line-height: 32px; }
        .item-lista-extra { background: #f8f9fa; border-left: 4px solid #0d6efd; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .form-section-title { color: #0d6efd; font-weight: 600; margin-top: 20px; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark sticky-top shadow">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="#">‚öôÔ∏è Painel Avan√ßado</a>
            <div>
                <a href="index.html" class="btn btn-outline-light btn-sm me-2">Ver Site ‚û°</a>
                <button onclick="sair()" class="btn btn-danger btn-sm">Sair üö™</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 mt-4 mb-5">
        
        <div class="row">
            <div class="col-lg-7 mb-4">
                <div class="card card-dashboard p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-primary fw-bold" id="tituloForm">‚ûï Novo Santo</h4>
                        <button onclick="limparFormulario()" class="btn btn-sm btn-outline-secondary" id="btnCancelar" style="display:none;">Cancelar Edi√ß√£o</button>
                    </div>

                    <form id="formSanto">
                        <input type="hidden" id="santoId">

                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label small fw-bold">Nome</label>
                                <input type="text" id="nome" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small fw-bold">T√≠tulo</label>
                                <input type="text" id="titulo" class="form-control" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label class="form-label small fw-bold">üë∂ Nascimento</label>
                                <input type="text" id="nascimento" class="form-control" placeholder="Ex: 1181">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label small fw-bold">‚úùÔ∏è Falecimento</label>
                                <input type="text" id="falecimento" class="form-control" placeholder="Ex: 1226">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label small fw-bold">üéâ Dia da Festa</label>
                                <input type="text" id="festa" class="form-control" placeholder="Ex: 4 de Outubro">
                            </div>
                        </div>

                        <div class="row mt-2">
                            <div class="col-md-6 mb-2">
                                <label class="form-label small fw-bold">Categoria</label>
                                <select id="categoriaId" class="form-select" required>
                                    <option value="" disabled selected>Selecione...</option>
                                    <option value="1">üî¥ M√°rtires</option>
                                    <option value="2">üîµ Marianos</option>
                                    <option value="3">üü§ Franciscanos</option>
                                    <option value="4">üü° Doutores</option>
                                    <option value="5">üü¢ Ap√≥stolos</option>
                                    <option value="6">üü£ Confessores</option>
                                    <option value="7">üü† Caridade</option>
                                    <option value="8">üå∏ Jovens</option>
                                    <option value="9">üåä Fundadores</option>
                                    <option value="10">üåë M√≠sticos</option>
                                    <option value="11">üçë Geral</option>
                                    <option value="12">üåø Anjos</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small fw-bold">Foto Banner (Principal)</label>
                                <input type="url" id="fotoUrl" class="form-control" placeholder="http://...">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Hist√≥ria Completa</label>
                            <textarea id="historia" class="form-control" rows="4" required></textarea>
                        </div>

                        <h6 class="form-section-title">‚ú® Milagres</h6>
                        <div id="container-milagres"></div>
                        <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="adicionarInputMilagre()">+ Adicionar Milagre</button>

                        <h6 class="form-section-title">üñºÔ∏è Galeria de Fotos</h6>
                        <div id="container-galeria"></div>
                        <button type="button" class="btn btn-sm btn-outline-success mb-3" onclick="adicionarInputGaleria()">+ Adicionar Foto Extra</button>

                        <h6 class="form-section-title">üìç Lugares (Passagem)</h6>
                        <div id="container-locais"></div>
                        <button type="button" class="btn btn-sm btn-outline-warning mb-3" onclick="adicionarInputLocal()">+ Adicionar Local</button>

                        <hr>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="ehFamoso" checked>
                            <label class="form-check-label small">Marcar como Destaque (Home)</label>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2 fw-bold" id="btnSalvar">üíæ SALVAR SANTO</button>
                    </form>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card card-dashboard p-4">
                    <h5 class="mb-3 text-secondary">üìã Lista Cadastrada</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>Categ.</th>
                                    <th class="text-end">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-santos"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('santosToken');
        if (!token) { alert("üîí Login necess√°rio!"); window.location.href = "login.html"; }
        function sair() { localStorage.removeItem('santosToken'); window.location.href = "login.html"; }

        const API_URL = 'http://localhost:5101/api/santos';
        
        carregarTudo();

        async function carregarTudo() {
            try {
                const res = await fetch(API_URL);
                const santos = await res.json();
                renderizarTabela(santos);
            } catch (err) { console.error(err); }
        }

        function renderizarTabela(santos) {
            const tbody = document.getElementById('tabela-santos');
            tbody.innerHTML = '';
            santos.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-truncate" style="max-width: 150px;">${s.nome}</td>
                        <td><span class="badge" style="background-color:${s.categoria?.corHex || '#ccc'}">${s.categoria?.nome?.substring(0,10) || '?'}..</span></td>
                        <td class="text-end">
                            <button onclick="carregarEdicao(${s.id})" class="btn btn-warning btn-circle btn-sm text-white" title="Editar">‚úèÔ∏è</button>
                            <button onclick="excluir(${s.id})" class="btn btn-danger btn-circle btn-sm text-white" title="Excluir">üóë</button>
                        </td>
                    </tr>`;
            });
        }

        async function carregarEdicao(id) {
            try {
                const res = await fetch(`${API_URL}/${id}`);
                const santo = await res.json();

                document.getElementById('santoId').value = santo.id;
                document.getElementById('nome').value = santo.nome;
                document.getElementById('titulo').value = santo.titulo;
                
                // PREENCHE OS NOVOS CAMPOS
                document.getElementById('nascimento').value = santo.nascimento || '';
                document.getElementById('falecimento').value = santo.falecimento || '';
                document.getElementById('festa').value = santo.festa || '';

                document.getElementById('categoriaId').value = santo.categoriaId;
                document.getElementById('fotoUrl').value = santo.fotoUrl;
                document.getElementById('historia').value = santo.historia;
                document.getElementById('ehFamoso').checked = santo.ehFamoso;

                // Limpa e Preenche Listas
                document.getElementById('container-milagres').innerHTML = '';
                if(santo.milagres) santo.milagres.forEach(m => adicionarInputMilagre(m.titulo, m.descricao));

                document.getElementById('container-galeria').innerHTML = '';
                if(santo.imagens) santo.imagens.forEach(i => adicionarInputGaleria(i.url));

                document.getElementById('container-locais').innerHTML = '';
                if(santo.locais) santo.locais.forEach(l => adicionarInputLocal(l.nomeLugar, l.descricao));

                document.getElementById('tituloForm').innerText = "‚úèÔ∏è Editando: " + santo.nome;
                document.getElementById('btnSalvar').innerText = "üîÑ ATUALIZAR DADOS";
                document.getElementById('btnSalvar').classList.replace('btn-primary', 'btn-warning');
                document.getElementById('btnCancelar').style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (err) { alert("Erro ao carregar dados."); }
        }

        function limparFormulario() {
            document.getElementById('formSanto').reset();
            document.getElementById('santoId').value = '';
            document.getElementById('container-milagres').innerHTML = '';
            document.getElementById('container-galeria').innerHTML = '';
            document.getElementById('container-locais').innerHTML = '';
            document.getElementById('tituloForm').innerText = "‚ûï Novo Santo";
            document.getElementById('btnSalvar').innerText = "üíæ SALVAR SANTO";
            document.getElementById('btnSalvar').classList.replace('btn-warning', 'btn-primary');
            document.getElementById('btnCancelar').style.display = 'none';
        }

        function adicionarInputMilagre(titulo = '', desc = '') {
            const div = document.createElement('div');
            div.className = 'item-lista-extra mb-2';
            div.innerHTML = `
                <input type="text" class="form-control form-control-sm mb-1 milagre-titulo" placeholder="T√≠tulo do Milagre" value="${titulo}">
                <textarea class="form-control form-control-sm mb-1 milagre-desc" placeholder="Descri√ß√£o">${desc}</textarea>
                <button type="button" class="btn btn-link btn-sm text-danger p-0" onclick="this.parentElement.remove()">Remover</button>
            `;
            document.getElementById('container-milagres').appendChild(div);
        }

        function adicionarInputGaleria(url = '') {
            const div = document.createElement('div');
            div.className = 'item-lista-extra mb-2 d-flex gap-2';
            div.innerHTML = `
                <input type="url" class="form-control form-control-sm galeria-url" placeholder="URL da imagem extra" value="${url}">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>
            `;
            document.getElementById('container-galeria').appendChild(div);
        }

        function adicionarInputLocal(nome = '', desc = '') {
            const div = document.createElement('div');
            div.className = 'item-lista-extra mb-2';
            div.innerHTML = `
                <input type="text" class="form-control form-control-sm mb-1 local-nome" placeholder="Nome do Lugar (Ex: Roma)" value="${nome}">
                <input type="text" class="form-control form-control-sm mb-1 local-desc" placeholder="O que aconteceu l√°?" value="${desc}">
                <button type="button" class="btn btn-link btn-sm text-danger p-0" onclick="this.parentElement.remove()">Remover</button>
            `;
            document.getElementById('container-locais').appendChild(div);
        }

        document.getElementById('formSanto').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('santoId').value;
            const ehEdicao = !!id;

            const santo = {
                id: ehEdicao ? parseInt(id) : 0,
                nome: document.getElementById('nome').value,
                titulo: document.getElementById('titulo').value,
                
                // CAPTURA OS NOVOS CAMPOS DO FORMUL√ÅRIO
                nascimento: document.getElementById('nascimento').value,
                falecimento: document.getElementById('falecimento').value,
                festa: document.getElementById('festa').value,

                categoriaId: parseInt(document.getElementById('categoriaId').value),
                fotoUrl: document.getElementById('fotoUrl').value,
                historia: document.getElementById('historia').value,
                ehFamoso: document.getElementById('ehFamoso').checked,
                milagres: [], imagens: [], locais: []
            };

            document.querySelectorAll('#container-milagres .item-lista-extra').forEach(el => {
                santo.milagres.push({ titulo: el.querySelector('.milagre-titulo').value, descricao: el.querySelector('.milagre-desc').value });
            });
            document.querySelectorAll('#container-galeria .item-lista-extra').forEach(el => {
                const url = el.querySelector('.galeria-url').value;
                if(url) santo.imagens.push({ url: url });
            });
            document.querySelectorAll('#container-locais .item-lista-extra').forEach(el => {
                santo.locais.push({ nomeLugar: el.querySelector('.local-nome').value, descricao: el.querySelector('.local-desc').value });
            });

            const metodo = ehEdicao ? 'PUT' : 'POST';
            const urlFinal = ehEdicao ? `${API_URL}/${id}` : API_URL;

            try {
                const res = await fetch(urlFinal, {
                    method: metodo,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(santo)
                });

                if(res.ok) {
                    alert(ehEdicao ? "‚úÖ Atualizado!" : "‚úÖ Cadastrado!");
                    limparFormulario();
                    carregarTudo();
                } else { alert("Erro ao salvar."); }
            } catch (err) { alert("Erro de conex√£o."); }
        });

        async function excluir(id) {
            if(confirm("Tem certeza?")) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                carregarTudo();
            }
        }
    </script>
</body>
</html>